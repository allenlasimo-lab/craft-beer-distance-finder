<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Craft Beer Distance Finder ‚Äî Import Text + Geocode + Road Distance</title>
<style>
  :root{--bg:#f5f5f5;--txt:#111;--muted:#666;--card:#fff;--border:#e5e5e5}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:900px){.row{grid-template-columns:7fr 5fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  h1{margin:0 0 6px;font-size:28px} h2{margin:0 0 12px;font-size:18px}
  .muted{color:var(--muted)} .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--border);background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .input, select, textarea{border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  .input{width:150px} .grow{flex:1}
  .shop{display:flex;gap:12px;justify-content:space-between;align-items:flex-start}
  .shop h3{margin:0 0 4px;font-size:18px}
  .list{display:flex;flex-direction:column;gap:12px}
  .footer{margin-top:28px;font-size:12px;color:var(--muted)}
  .right{display:flex;gap:8px}
  .bad{background:#fff3f3;border-color:#ffd6d6}
  .ok{background:#f3fff5;border-color:#c8f0d0}
  .progress{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:#111;transition:width .3s}
</style>
</head>
<body>
  <div class="container">
    <header class="card">
      <div style="display:flex;gap:12px;justify-content:space-between;align-items:flex-end;flex-wrap:wrap">
        <div>
          <h1>üç∫ Craft Beer Distance Finder (TH)</h1>
          <div class="muted">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏¥‡∏™‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô ‚Üí geocode ‡∏´‡∏≤ lat/lng ‚Üí ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ñ‡∏ô‡∏ô (OSRM)</div>
        </div>
        <div class="right">
          <button id="exportBtn" class="btn">Export JSON</button>
          <button id="toggleImport" class="btn">Import JSON</button>
        </div>
      </div>
    </header>

    <!-- Import JSON (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <section id="importBox" class="card bad" style="display:none">
      <h2>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô (JSON)</h2>
      <div class="muted" style="margin-bottom:8px">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <span class="mono">[{name, city, lat, lng, address, url}, ...]</span></div>
      <textarea id="importText" rows="7" style="width:100%" placeholder='[
  {"name":"Your Taproom","city":"Bangkok","lat":13.75,"lng":100.50,"address":"...","url":"https://..."}
]'></textarea>
      <div class="controls" style="margin-top:8px">
        <button id="doImport" class="btn primary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
        <button id="cancelImport" class="btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </section>

    <!-- Import TEXT (‡πÉ‡∏´‡∏°‡πà) -->
    <section class="card ok">
      <h2>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏¥‡∏ö (‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</h2>
      <div class="muted" style="margin-bottom:8px">
        ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô<br>
        <span class="mono">1. Hair of the Dog\tPhrom Phong\tQuirky medical-themed...</span><br>
        ‡∏´‡∏£‡∏∑‡∏≠ <span class="mono">Two Palms Taproom (Old Town) - Local focus, flights</span>
      </div>
      <textarea id="rawText" rows="8" style="width:100%" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
      <div class="controls" style="margin-top:8px">
        <button id="convertBtn" class="btn primary">Convert ‚Üí ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</button>
        <button id="clearRaw" class="btn">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
      <div id="convertInfo" class="muted" style="margin-top:6px"></div>
    </section>

    <div class="row">
      <section class="card">
        <h2>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
        <div class="controls">
          <button id="useLoc" class="btn primary">‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
          <button id="clearLoc" class="btn">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
          <input id="lat" class="input" placeholder="‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (13.75)" />
          <input id="lng" class="input" placeholder="‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (100.50)" />
          <button id="setManual" class="btn">‡∏ï‡∏±‡πâ‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏≠‡∏á</button>
          <span class="muted" style="margin-left:auto">‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
          <select id="unit">
            <option value="km" selected>‡∏Å‡∏°.</option>
            <option value="mi">‡πÑ‡∏°‡∏•‡πå</option>
          </select>
          <span class="muted">‡πÇ‡∏´‡∏°‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</span>
          <select id="mode">
            <option value="air" selected>‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á (‡πÄ‡∏£‡πá‡∏ß)</option>
            <option value="driving">‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ (OSRM)</option>
            <option value="walking">‡πÄ‡∏î‡∏¥‡∏ô (OSRM)</option>
            <option value="cycling">‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô (OSRM)</option>
          </select>
        </div>
        <div id="locInfo" class="muted" style="margin-top:6px"></div>
        <div id="osrmNote" class="muted" style="margin-top:6px;display:none;font-size:12px">
          * ‡πÇ‡∏´‡∏°‡∏î OSRM ‡πÉ‡∏ä‡πâ <span class="mono">router.project-osrm.org</span> (‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞) ‡∏≠‡∏≤‡∏à‡∏´‡∏ô‡πà‡∏ß‡∏á/‡∏°‡∏µ‡∏•‡∏¥‡∏°‡∏¥‡∏ï
        </div>
      </section>

      <section class="card">
        <h2>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á/‡πÄ‡∏£‡∏µ‡∏¢‡∏á & Geocode</h2>
        <div class="controls">
          <input id="query" class="input grow" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / ‡πÄ‡∏°‡∏∑‡∏≠‡∏á / ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" />
          <select id="city"></select>
          <select id="sort">
            <option value="distance" selected>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</option>
            <option value="name">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠</option>
          </select>
        </div>
        <div class="controls" style="margin-top:8px">
          <button id="geocodeAll" class="btn primary">Geocode ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î)</button>
          <button id="stopGeocode" class="btn">‡∏´‡∏¢‡∏∏‡∏î</button>
          <span id="geoCount" class="muted"></span>
        </div>
        <div class="progress" style="margin-top:6px"><div id="geoBar" class="bar"></div></div>
        <div class="muted" style="margin-top:6px">* ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô HTTPS ‡∏´‡∏£‡∏∑‡∏≠ http://localhost ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
      </section>
    </div>

    <section style="margin-top:16px">
      <div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="resultTitle">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
        <div id="modeLabel" class="muted">‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á (Haversine)</div>
      </div>
      <div id="list" class="list" style="margin-top:12px"></div>
    </section>

    <div class="footer">
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: Geocode ‡πÉ‡∏ä‡πâ Nominatim (OpenStreetMap) ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏°‡∏µ‡πÅ‡∏Ñ‡∏ä‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥; ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‚Äú‡∏ñ‡∏ô‡∏ô‡∏à‡∏£‡∏¥‡∏á‚Äù ‡πÉ‡∏ä‡πâ OSRM
    </div>
  </div>

<script>
  // ---------- Base data & Utils ----------
  const KM_TO_MI = 0.621371;
  const DEFAULT_SHOPS = []; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì Convert/Import ‡πÄ‡∏≠‡∏á

  function toRad(d){return d*Math.PI/180}
  function haversine(lat1,lon1,lat2,lon2,unit="km"){
    const R = unit==="km"?6371:3958.8;
    const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }
  function keyFor(o,d,profile){ const f=n=>Number(n).toFixed(5); return `${f(o.lat)},${f(o.lng)}|${f(d.lat)},${f(d.lng)}|${profile}` }
  function gmapsUrl(name, city){ return `https://www.google.com/maps?q=${encodeURIComponent(`${name} ${city||""} Thailand`)}` }

  // ---------- OSRM (road distance) ----------
  async function roadDistanceKm_OSRM(origin, dest, profile='driving') {
    const f = (n)=>Number(n).toFixed(5);
    const coords = `${f(origin.lng)},${f(origin.lat)};${f(dest.lng)},${f(dest.lat)}`; // lon,lat;lon,lat
    const url = `https://router.project-osrm.org/route/v1/${profile}/${coords}?overview=false&alternatives=false&steps=false`;
    try{
      const res = await fetch(url,{headers:{Accept:'application/json'}});
      if(!res.ok) throw new Error(`OSRM HTTP ${res.status}`);
      const data = await res.json();
      if(data.code!=='Ok' || !data.routes?.[0]) return null;
      return data.routes[0].distance/1000; // km
    }catch(e){
      console.warn('OSRM error:',e);
      return null;
    }
  }
  const routeCache = new Map();

  // ---------- Nominatim (geocode) ----------
  const G_CACHE_KEY = 'geocode_cache_v1';
  const geocodeCache = JSON.parse(localStorage.getItem(G_CACHE_KEY) || '{}');

  function geocodeKey(q){ return q.toLowerCase().trim(); }

  async function geocodeOne(name, city){
    const q = `${name} ${city||""} Thailand`.trim();
    const k = geocodeKey(q);
    if(geocodeCache[k]) return geocodeCache[k];

    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
    if(!res.ok) throw new Error(`Nominatim HTTP ${res.status}`);
    const arr = await res.json();
    if(Array.isArray(arr) && arr[0]){
      const { lat, lon } = arr[0];
      const out = { lat: Number(lat), lng: Number(lon) };
      geocodeCache[k] = out;
      localStorage.setItem(G_CACHE_KEY, JSON.stringify(geocodeCache));
      return out;
    }
    return null;
  }

  // ---------- State ----------
  let unit = "km";
  let mode = "air"; // air | driving | walking | cycling
  let shops = [...DEFAULT_SHOPS];
  let myLoc = null;
  let query = "";
  let cityFilter = "all";
  let sortKey = "distance";

  // geocode control
  let stopFlag = false;

  // ---------- DOM ----------
  const $resultTitle = document.getElementById("resultTitle");
  const $modeLabel   = document.getElementById("modeLabel");
  const $list = document.getElementById("list");
  const $unit = document.getElementById("unit");
  const $mode = document.getElementById("mode");
  const $osrmNote = document.getElementById("osrmNote");
  const $useLoc = document.getElementById("useLoc");
  const $clearLoc = document.getElementById("clearLoc");
  const $lat = document.getElementById("lat");
  const $lng = document.getElementById("lng");
  const $setManual = document.getElementById("setManual");
  const $locInfo = document.getElementById("locInfo");
  const $query = document.getElementById("query");
  const $city = document.getElementById("city");
  const $sort = document.getElementById("sort");
  const $exportBtn = document.getElementById("exportBtn");
  const $toggleImport = document.getElementById("toggleImport");
  const $importBox = document.getElementById("importBox");
  const $importText = document.getElementById("importText");
  const $doImport = document.getElementById("doImport");
  const $cancelImport = document.getElementById("cancelImport");

  const $rawText = document.getElementById("rawText");
  const $convertBtn = document.getElementById("convertBtn");
  const $clearRaw = document.getElementById("clearRaw");
  const $convertInfo = document.getElementById("convertInfo");

  const $geocodeAll = document.getElementById("geocodeAll");
  const $stopGeocode = document.getElementById("stopGeocode");
  const $geoCount = document.getElementById("geoCount");
  const $geoBar = document.getElementById("geoBar");

  function refreshCityOptions(){
    const cities = Array.from(new Set(shops.map(s=>s.city).filter(Boolean))).sort();
    $city.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>` + cities.map(c=>`<option value="${c}">${c}</option>`).join("");
    $city.value = cityFilter;
  }

  function computeRows(){
    const rows = shops
      .map(s=>{
        let distance = null;
        if(myLoc && Number.isFinite(s.lat) && Number.isFinite(s.lng)){
          if(mode==='air'){
            distance = haversine(myLoc.lat,myLoc.lng,s.lat,s.lng,unit);
          }else{
            const km = routeCache.get(keyFor(myLoc,s,mode));
            if(typeof km === 'number') distance = (unit==='km'? km : km*KM_TO_MI);
          }
        }
        return {...s, distance};
      })
      .filter(s=>{
        const qok = !query || (s.name+" "+s.city+" "+(s.address||"")).toLowerCase().includes(query.toLowerCase());
        const cok = (cityFilter==="all") || s.city===cityFilter;
        return qok && cok;
      })
      .sort((a,b)=>{
        if(sortKey==="name") return a.name.localeCompare(b.name);
        if(a.distance==null && b.distance==null) return a.name.localeCompare(b.name);
        if(a.distance==null) return 1;
        if(b.distance==null) return -1;
        return a.distance - b.distance;
      });
    return rows;
  }

  async function fetchVisibleRoadDistances(rows){
    if(!myLoc || mode==='air') return;
    const todo = rows.filter(s=>Number.isFinite(s.lat)&&Number.isFinite(s.lng)).slice(0, 25);
    for(const s of todo){
      const key = keyFor(myLoc, s, mode);
      if(routeCache.has(key)) continue;
      const km = await roadDistanceKm_OSRM(myLoc, s, mode);
      if(km!=null) routeCache.set(key, km);
    }
  }

  function render(){
    const rows = computeRows();
    $resultTitle.textContent = `‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (${rows.length} ‡∏£‡πâ‡∏≤‡∏ô)`;
    $modeLabel.textContent = mode==='air' ? '‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á (Haversine)' :
      `‡πÇ‡∏´‡∏°‡∏î: ${mode==='driving'?'‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ':mode==='walking'?'‡πÄ‡∏î‡∏¥‡∏ô':'‡∏õ‡∏±‡πà‡∏ô‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô'} (OSRM)`;
    $osrmNote.style.display = mode==='air' ? 'none':'block';

    $list.innerHTML = rows.map(s=>`
      <div class="card">
        <div class="shop">
          <div>
            <h3>${s.name}</h3>
            <div class="muted">${s.city||''}${s.address?` ‚Ä¢ ${s.address}`:""}</div>
            ${
              (s.distance!=null)
                ? `<div><b>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</b> ${s.distance.toFixed(2)} ${unit}</div>`
                : (myLoc
                    ? (Number.isFinite(s.lat)&&Number.isFinite(s.lng)
                        ? (mode==='air'
                            ? `<div class="muted">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...)</div>`
                            : `<div class="muted">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á...)</div>`
                          )
                        : `<div class="muted">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô ‚Äî ‡πÉ‡∏ä‡πâ Geocode ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</div>`
                      )
                    : `<div class="muted">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</div>`
                  )
            }
          </div>
          <div class="right">
            <button class="btn primary" onclick="openDirections(${Number.isFinite(s.lat)?s.lat:'null'},${Number.isFinite(s.lng)?s.lng:'null'},'${encodeURIComponent(s.name)}')">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</button>
            <a class="btn" href="${s.url || gmapsUrl(s.name, s.city)}" target="_blank" rel="noreferrer">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
          </div>
        </div>
      </div>
    `).join("");

    fetchVisibleRoadDistances(rows).then(()=> {
      if(mode!=='air') {
        const after = computeRows();
        if(JSON.stringify(rows.map(r=>r.distance)) !== JSON.stringify(after.map(r=>r.distance))){
          render();
        }
      }
    });

    refreshCityOptions();
    updateGeoCounter();
  }

  function setLocInfo(){
    if(myLoc) $locInfo.innerHTML = `‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span class="mono">${myLoc.lat.toFixed(5)}, ${myLoc.lng.toFixed(5)}</span>`;
    else $locInfo.textContent = "";
  }

  // ---------- Import Text ‚Üí shops ----------
  function parseRawText(txt){
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      if(/^‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô/i.test(line)) continue;

      if (line.includes('\t')) {
        const cells = line.split('\t').map(s=>s.trim());
        while(cells.length<3) cells.push('');
        let [name, city, desc] = cells.slice(0,3);
        name = name.replace(/^\d+\.\s*/, '').trim();
        out.push({ name, city, address: desc, lat: null, lng: null, url: gmapsUrl(name, city) });
      } else {
        // patterns: "Name (City) - Desc" OR "Name - Desc" OR just "Name"
        const m = line.match(/^\s*\d*\.?\s*(.*?)\s*\((.*?)\)\s*-\s*(.*)$/);
        if(m){
          const name = m[1].trim(), city = m[2].trim(), desc = m[3].trim();
          out.push({ name, city, address: desc, lat: null, lng: null, url: gmapsUrl(name, city) });
        } else {
          const m2 = line.match(/^\s*\d*\.?\s*(.*?)\s*-\s*(.*)$/);
          if(m2){
            const name = m2[1].trim(), desc = m2[2].trim();
            out.push({ name, city: "", address: desc, lat: null, lng: null, url: gmapsUrl(name, "") });
          } else {
            const name = line.replace(/^\d+\.\s*/, '').trim();
            if(name) out.push({ name, city: "", address: "", lat: null, lng: null, url: gmapsUrl(name, "") });
          }
        }
      }
    }
    return out;
  }

  // ---------- Geocode batch ----------
  function countMissing(){ return shops.filter(s=>!(Number.isFinite(s.lat)&&Number.isFinite(s.lng))).length }
  function updateGeoCounter(){
    const missing = countMissing();
    $geoCount.textContent = `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${missing} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    const total = shops.length || 1;
    const done = total - missing;
    const pct = Math.round((done/total)*100);
    $geoBar.style.width = pct + '%';
  }

  async function geocodeAll(){
    stopFlag = false;
    const total = shops.length;
    for(let i=0;i<shops.length;i++){
      if(stopFlag) break;
      const s = shops[i];
      if(!(Number.isFinite(s.lat)&&Number.isFinite(s.lng))){
        try{
          const got = await geocodeOne(s.name, s.city);
          if(got){ s.lat = got.lat; s.lng = got.lng; }
        }catch(e){ console.warn('Geocode error:', e); }
        updateGeoCounter();
        render();
        // ‡πÄ‡∏ß‡πâ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏ô‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡πÉ‡∏à‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
        await new Promise(r=>setTimeout(r, 1200));
      }
    }
  }

  // ---------- Init & Events ----------
  render();

  $unit.onchange = ()=>{ unit = $unit.value; render(); }
  $mode.onchange = ()=>{ mode = $mode.value; render(); }

  $useLoc.onclick = ()=>{
    if(!("geolocation" in navigator)) return alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
    navigator.geolocation.getCurrentPosition(
      pos=>{ myLoc = {lat:pos.coords.latitude, lng:pos.coords.longitude}; setLocInfo(); render(); },
      err=>alert("‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+err.message),
      {enableHighAccuracy:true,timeout:10000}
    );
  }
  $clearLoc.onclick = ()=>{ myLoc = null; setLocInfo(); render(); }
  $setManual.onclick = ()=>{
    const lat = parseFloat($lat.value), lng = parseFloat($lng.value);
    if(Number.isFinite(lat) && Number.isFinite(lng)){ myLoc = {lat,lng}; setLocInfo(); render(); }
    else alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î/‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
  }
  $query.oninput = ()=>{ query = $query.value.trim(); render(); }
  $city.onchange = ()=>{ cityFilter = $city.value; render(); }
  $sort.onchange = ()=>{ sortKey = $sort.value; render(); }

  $exportBtn.onclick = async ()=>{
    const text = JSON.stringify(shops.map(({id, ...r})=>r), null, 2);
    try{ await navigator.clipboard.writeText(text); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß"); }
    catch{ alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ"); console.log(text); }
  }

  $toggleImport.onclick = ()=>{ $importBox.style.display = $importBox.style.display==="none"?"block":"none"; }
  $cancelImport.onclick = ()=>{ $importText.value=""; $importBox.style.display="none"; }
  $doImport.onclick = ()=>{
    try{
      const parsed = JSON.parse($importText.value);
      if(!Array.isArray(parsed)) throw new Error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array");
      const normalized = parsed.map((s,idx)=>({
        id: Date.now()+idx,
        name: s.name ?? "Unnamed",
        city: s.city ?? "",
        lat: Number(s.lat),
        lng: Number(s.lng),
        address: s.address ?? "",
        url: s.url ?? ""
      })).filter(s=>!Number.isNaN(s.lat)&&!Number.isNaN(s.lng));
      shops = normalized;
      render();
      $importText.value=""; $importBox.style.display="none";
    }catch(e){ alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+e.message); }
  }

  $convertBtn.onclick = ()=>{
    try{
      const arr = parseRawText($rawText.value || "");
      // ‡πÉ‡∏™‡πà id ‡πÉ‡∏´‡πâ‡∏î‡πâ‡∏ß‡∏¢
      shops = arr.map((s,idx)=>({ id: Date.now()+idx, ...s }));
      $convertInfo.textContent = `‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß ${shops.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äì ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏Å‡∏î Geocode ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`;
      render();
    }catch(e){
      alert("‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: "+e.message);
    }
  };
  $clearRaw.onclick = ()=>{ $rawText.value=""; $convertInfo.textContent=""; };

  $geocodeAll.onclick = ()=> geocodeAll();
  $stopGeocode.onclick = ()=>{ stopFlag = true; };
  
  // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
  window.openDirections = (lat,lng,name)=>{
    if(myLoc && Number.isFinite(lat) && Number.isFinite(lng)){
      const url = `https://www.google.com/maps/dir/?api=1&origin=${myLoc.lat},${myLoc.lng}&destination=${lat},${lng}`;
      window.open(url,"_blank");
    }else{
      window.open(`https://www.google.com/maps?q=${name}`,"_blank");
    }
  }
</script>
</body>
</html>
